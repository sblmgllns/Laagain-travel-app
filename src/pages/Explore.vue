<script setup>
import { ref, computed, onMounted } from 'vue';
import { cards } from '../assets/scripts/explore.js';
import { supabase } from '../supabase';

const profilePicUrl = ref(null);
const modalItem = ref(null);
const activeTab = ref('attractions');
const bookmarkedItems = ref([]);
const userId = ref(null);
const userTrips = ref([]);
const selectedTripId = ref('');

// Get current user on mount
onMounted(async () => {
   // 1. Get current user
  const {
    data: { user },
    error: userError
  } = await supabase.auth.getUser()

  if (userError) {
    console.error('Error getting user:', userError)
    return
  }
  userId.value = user.id;
  console.log(userId.value);
  // 2. Fetch user record from 'users' table
  const { data, error } = await supabase
    .from('profiles')
    .select('profile_pic_url')
    .eq('id', user.id) // assuming your 'users' table uses auth user id
    .single()

  if (error) {
    console.error('Error fetching profile_pic_url:', error)
  } else {
    profilePicUrl.value = data.profile_pic_url
  }

  // Load bookmarks
  await loadBookmarks();
  await loadUserTrips();
});

const handleAddActivity = async (item) => {
  console.log("here", item.title);
  const newActivity = {
    name: item.title,
    description: "",
    location: "",
    date: "",
    start_time: null,
    end_time: null,
    itinerary_id: selectedTripId.value,
  };

  try {
    const { error } = await supabase.from('potential_activities').insert(newActivity);

    if (error) {
      console.error("Error inserting activity:", error.message);
    } else {
      console.log("Activity inserted successfully");

      // Close modal
      const modalEl = document.getElementById("detailsModal");
      const modalInstance = bootstrap.Modal.getInstance(modalEl);
      if (modalInstance) {
        modalInstance.hide();
      }

      // Show notification (simple toast or alert)
      const alert = document.createElement("div");
      alert.className = "alert alert-success position-fixed top-0 end-0 m-3";
      alert.style.zIndex = 1055;
      alert.innerText = "Activity added successfully!";
      document.body.appendChild(alert);

      // Auto-remove after 3 seconds
      setTimeout(() => {
        alert.remove();
      }, 5000);
      window.location.reload();
    }
  } catch (err) {
    console.error("Unexpected error inserting activity:", err);
  }
};


async function loadUserTrips() {
  if (!userId.value) return;

  try {
    // Fetch owned trips (only id and name)
    const { data: ownedTrips, error: ownedError } = await supabase
      .from('itineraries')
      .select('id, name')
      .eq('owner_id', userId.value);

    if (ownedError) throw ownedError;

    // Fetch member trips (only id and name)
    const { data: memberTrips, error: memberError } = await supabase
      .from('itinerary_members')
      .select(`
        itineraries:itinerary_id (id, name)
      `)
      .eq('user_id', userId.value);

    if (memberError) throw memberError;

    // Format and combine results
    const formattedOwnedTrips = ownedTrips.map(trip => ({
      id: trip.id,
      name: trip.name
    }));

    const formattedMemberTrips = memberTrips.map(member => ({
      id: member.itineraries.id,
      name: member.itineraries.name
    }));

    userTrips.value = [...formattedOwnedTrips, ...formattedMemberTrips];
  } catch (error) {
    console.error('Error loading trips:', error);
  }
}

async function loadBookmarks() {
  if (!userId.value) return;
  
  const { data, error } = await supabase
    .from('bookmarks')
    .select('*')
    .eq('user_id', userId.value);

  if (error) {
    console.error('Error loading bookmarks:', error);
    return;
  }

  bookmarkedItems.value = data.map(item => ({
    id: item.card_id,
    title: item.title,
    image: item.image,
    category: item.category,
    price: item.price,
    type: item.type,
    rating: item.rating || 0,
    reviews: item.reviews || 0,
    booked: item.booked || ''
  }));
}

async function toggleBookmark(item) {
  if (!userId.value) {
    console.error('User not logged in');
    return;
  }

  console.log("Toggle", item);
  // Generate an ID if one doesn't exist (fallback)
  const cardId = item.id;
  const isBookmarked = bookmarkedItems.value.some(bookmark => 
    bookmark.id === cardId || bookmark.title === item.title
  );

  try {
    if (isBookmarked) {
      // Remove bookmark
      const { error } = await supabase
        .from('bookmarks')
        .delete()
        .eq('user_id', userId.value)
        .or(`card_id.eq.${cardId},title.eq.${item.title}`);

      if (error) throw error;
      bookmarkedItems.value = bookmarkedItems.value.filter(
        bookmark => bookmark.id !== cardId && bookmark.title !== item.title
      );
    } else {
      // Add bookmark
      const { error } = await supabase
        .from('bookmarks')
        .insert([
          { 
            user_id: userId.value, 
            card_id: cardId,
            title: item.title, // Store title as fallback
            image: item.image,
            category: item.category,
            price: item.price,
            type: item.type
          }
        ]);

      if (error) throw error;
      bookmarkedItems.value = [...bookmarkedItems.value, { ...item, id: cardId }];
    }
  } catch (error) {
    console.error('Bookmark error:', error);
  }
}

function isBookmarked(item) {
  if (!item || !item.id || !bookmarkedItems.value) return false;
  return bookmarkedItems.value.some(bookmark => bookmark.id === item.id);
}

function showDetails(item) {
  modalItem.value = item;
}

const filteredCards = computed(() => {
  if (activeTab.value === 'bookmarks') {
    return bookmarkedItems.value;
  }
  return cards.value.filter(card => card.type === activeTab.value);
});
</script>

<template>
    <!-- Fixed Top Bar -->
    <div class="top-bar w-100 d-flex align-items-center">
        <div class="col-auto d-flex align-items-center justify-content-center">
          <img 
            :src="profilePicUrl" 
            alt="Profile Picture" 
            class="rounded-circle border border-white shadow-sm img-fluid"
            style="width: 80px; height: 80px; object-fit: cover;" 
          />
        </div>

    </div>

  <div class="results-page">

    <aside class="sidebar">
        <div class="filter-group">
            <h5>Location</h5>
            <button class="select-loc-btn btn btn-outline-primary d-flex align-items-center gap-2" type="button" data-bs-toggle="modal" data-bs-target="#locationModal">
                <i class="bi bi-geo-alt"></i>
                <span>Select location</span>
            </button>
        </div>

      <div class="filter-group">
        <h5>Price range</h5>
        <input type="range" class="form-range" min="0" max="1042" />
        <div class="d-flex justify-content-between">
          <span>PHP 0</span>
          <span>PHP 1000</span>
        </div>
      </div>
    </aside>

    <main class="results">
      <div class="results-header d-flex justify-content-between align-items-center">
        <form class="search-form d-flex" role="search">
            <div class="input-group rounded-input">
                <span class="input-group-text bg-white border-end-0">
                    <i class="bi bi-search"></i>
                </span>
                <input type="search"  class="input-bar" placeholder="Search" aria-label="Search">
                <!-- <button class="btn btn-primary" type="submit">Search</button> -->
            </div>
        </form>

        <h6>{{ filteredCards.length }} results found</h6>

        <select class="form-select w-auto">
          <option selected>Relevance</option>
          <option>Price: Low to High</option>
          <option>Price: High to Low</option>
          <option>Rating: High to Low</option>
          <option>Rating: Low to High</option>
        </select>
      </div>

      <!-- Tabs -->
      <div class="d-flex tabs my-3">
        <button
          class="btn me-2"
          :class="{'btn-primary': activeTab === 'bookmarks', 'btn-outline-primary': activeTab !== 'bookmarks'}"
          @click="activeTab = 'bookmarks'"
        >
          Bookmarks
        </button>

        <button
          class="btn me-2"
          :class="{'btn-primary': activeTab === 'attractions', 'btn-outline-primary': activeTab !== 'attractions'}"
          @click="activeTab = 'attractions'"
        >
          Attractions
        </button>

        <button
          class="btn me-2"
          :class="{'btn-primary': activeTab === 'hotels', 'btn-outline-primary': activeTab !== 'hotels'}"
          @click="activeTab = 'hotels'"
        >
          Hotels
        </button>
      </div>

      <div class="card-grid">
        <div class="result-card" v-for="(item, index) in filteredCards" :key="index">
          <img :src="item.image" class="card-img-top" />
          <div class="card-body">
            <p class="category">{{ item.category }}</p>
            <h6 class="card-title">{{ item.title }}</h6>
            <div class="rating">
              <i class="bi bi-star-fill text-warning"></i> {{ item.rating }} ({{ item.reviews }}) â€¢ {{ item.booked }}
            </div>
            <p class="price">From US$ {{ item.price.toFixed(2) }}</p>
            <button
            class="btn btn-outline-primary btn-sm"
            data-bs-toggle="modal"
            data-bs-target="#detailsModal"
            @click="showDetails(item)"
            >
            View Details
            </button>
            <button 
            class="btn"
            @click="toggleBookmark(item)"
          >
            <i 
              class="bi"
              :class="{
                'bi-bookmark-fill bookmark-yellow': isBookmarked(item),
                'bi-bookmark': !isBookmarked(item)
              }"
            ></i>
          </button>
          </div>
        </div>
      </div>
    </main>

    <!-- Bottom Navigation Bar -->
    <div class="position-absolute start-50 translate-middle-x bottom-0 mb-4 w-50 bg-white rounded-pill shadow-lg py-3 d-flex justify-content-around align-items-center text-decoration-none"
        style="height: 70px; 
               box-shadow: 
                   inset 0px 5px 10px rgba(150, 150, 150, 0.5),  
                   0px 10px 30px rgba(100, 100, 100, 0.7);">
        
        <!-- Trips -->
        <div class="text-center">
          <router-link to="/dashboard" class="text-decoration-none d-flex flex-column align-items-center nav-item">
            <i class="bi bi-suitcase-fill fs-4 text-gray"></i>
            <p class="fw-bold m-0 small text-gray">Trips</p>
          </router-link>
        </div>

        <!-- Explore -->
        <div class="text-center">
          <router-link to="/explore" class="text-decoration-none d-flex flex-column align-items-center nav-item">
            <i class="bi bi-compass-fill fs-4 text-gray"></i>
            <p class="fw-bold m-0 small text-gray">Explore</p>
          </router-link>
        </div>

        <!-- Plus Button (Centered Floating Button) -->
        <div class="position-absolute start-50 translate-middle rounded-circle d-flex align-items-center justify-content-center"
            style="width: 60px; height: 60px; top: -5px; background-color: #03AED2; 
                box-shadow: 0px 5px 15px rgba(0, 0, 0, 0.3);">

            <router-link to="/new-itinerary" class="text-white text-decoration-none d-flex align-items-center justify-content-center w-100 h-100">
                <i class="bi bi-plus-lg" 
                style="font-size: 2.5rem; /* Make it bigger */
                        font-weight: bold; 
                        -webkit-text-stroke: 3px white; 
                        text-stroke: 3px white;"></i>
            </router-link>
        </div>

        <!-- Hotel -->
        <div class="text-center">
          <router-link to="/hotel" class="text-decoration-none d-flex flex-column align-items-center nav-item">
            <i class="bi bi-building-fill fs-4 text-gray"></i>
            <p class="fw-bold m-0 small text-gray">Hotel</p>
          </router-link>
        </div>

        <!-- Profile -->
        <div class="text-center">
          <router-link to="/profile" class="text-decoration-none d-flex flex-column align-items-center nav-item">
            <i class="bi bi-person-fill fs-4 text-gray"></i>
            <p class="fw-bold m-0 small text-gray">Profile</p>
          </router-link>
        </div>
      </div>
  </div>


    <!-- Location Modal -->
    <div class="modal fade" id="locationModal" tabindex="-1" aria-labelledby="locationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="loc-modal modal-content rounded-4 p-3">

            <div class="modal-body">
                <!-- Search bar -->
                <input type="text" class="form-control form-control-lg mb-4 rounded-pill px-4" placeholder="Search by city, region or country">

                <!-- Country and city options -->
                <div class="mb-3">
                <div class="mt-2 d-flex flex-wrap gap-2 ps-4">
                    <span class="btn btn-outline-secondary rounded-pill">Cebu</span>
                    <span class="btn btn-outline-secondary rounded-pill">Bohol</span>
                    <span class="btn btn-outline-secondary rounded-pill">Tacloban</span>
                </div>
                </div>
            </div>

            <!-- Footer with Clear and Confirm -->
            <div class="modal-footer border-0 justify-content-between">
                <button type="button" class="btn btn-link text-decoration-none">Clear</button>
                <button type="button" class="btn btn-warning text-white px-4">Confirm</button>
            </div>

            </div>
        </div>
    </div>

    <!-- Details ModAL -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailsModalLabel">{{ modalItem?.title }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body d-flex flex-column flex-md-row">
                <img :src="modalItem?.image" class="img-fluid me-md-3 mb-3" style="max-width: 300px;" />
                <div>
                    <div class="justify-content-start">
                        <p class="text-muted">{{ modalItem?.category }}</p>
                        <p><strong>Price:</strong> US$ {{ modalItem?.price?.toFixed(2) }}</p>
                        <p><strong>Rating:</strong> {{ modalItem?.rating }} ({{ modalItem?.reviews }})</p>
                        <p><strong>Booked:</strong> {{ modalItem?.booked }}</p>
                        <p><strong>Website:</strong> <a href="#">Visit site</a></p>
                    </div>
                    <button 
                      class="btn"
                      @click="toggleBookmark(modalItem)"
                    >
                      <i 
                        class="bi"
                        :class="{
                          'bi-bookmark-fill text-primary': isBookmarked(modalItem),
                          'bi-bookmark': !isBookmarked(modalItem)
                        }"
                      ></i>
                    </button>
                    <div class="d-flex justify-content-end mt-3">
                        <div class="dropdown me-2">
                        <!-- <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            Choose Itinerary
                        </button>
        
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#">Favorites</a></li>
                            <li><a class="dropdown-item" href="#">Wishlist</a></li>
                        </ul> -->

                        <select class="form-select w-auto" v-model="selectedTripId">
                          <option disabled value="">Select a Trip</option>
                          <option 
                            v-for="trip in userTrips" 
                            :key="trip.id" 
                            :value="trip.id"
                          >
                            {{ trip.name }}
                          </option>
                        </select>
                        </div>
                        <button @click="handleAddActivity(modalItem)" class="btn btn-primary">
                          Add
                        </button>
                    </div>
                </div>
            </div>
            </div>
        </div>
    </div>
  

</template>


<style scoped>
@import "../assets/styles/explore.css"; /* Import external CSS file */
</style>
